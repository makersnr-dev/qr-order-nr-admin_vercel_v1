<!doctype html><html lang="ko"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>관리자 콘솔</title>
<style>
  :root{--bg:#0b0f14;--panel:#0d131b;--line:#223;--text:#e6edf3;--muted:#9fb0c3}
  body{font-family:system-ui,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text);margin:0}
  .wrap{max-width:980px;margin:22px auto;padding:16px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:10px 14px;border:1px solid #294760;border-radius:10px;background:#0c1a28;cursor:pointer}
  .tab.active{outline:2px solid #2a6ea9}
  .card{background:#0d131b;border:1px solid #223;border-radius:14px;padding:14px;margin-bottom:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 12px;border:1px solid #294760;border-radius:10px;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer}
  input,select{padding:8px;border-radius:10px;border:1px solid #223;background:#0e1520;color:#e6edf3}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #222;padding:8px;text-align:left}
  .pill{display:inline-block;padding:4px 8px;border-radius:24px;border:1px solid #345;font-size:12px}
  .pill.ok{background:#0b2a18;border-color:#1f4e32;color:#b3ffcf}
  .pill.warn{background:#2a160b;border-color:#4e331f;color:#ffd9b3}
  .muted{color:var(--muted)} .hidden{display:none}

/* === QR 배포 보조 UI (v5.11) === */
.qr-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:8px}
.qr-card{background:#0e1a26;border:1px solid #234;border-radius:12px;padding:10px;text-align:center}
.qr-card img{width:100%;height:auto;image-rendering:pixelated}
.qr-meta{margin-top:6px;font-weight:600}
.qr-actions{display:flex;gap:8px;justify-content:center;margin-top:6px}
.qr-actions .btn{padding:4px 8px;border-radius:10px}
#qrPreviewDet{margin-top:8px}
#qrPreviewCanvas{max-width:256px;width:100%;border-radius:8px;display:none}
#qrPreviewImg{max-width:256px;width:100%;border-radius:8px;display:none}
#qrPreviewHint{opacity:.65;font-size:.9em;margin:6px 0 0}
.qr-hidden-source{display:none !important;width:0 !important;height:0 !important;overflow:hidden !important;}
.qr-legacy-hide{display:none !important;}

</style>
</head><body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h2>관리자 콘솔</h2>
    <div class="row">
      <a class="btn" href="/login">로그인</a>
      <button class="btn" id="logoutBtn">로그아웃</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="orders">주문목록</div>
    <div class="tab" data-tab="qr">QR 배포</div>
    <div class="tab" data-tab="menu">메뉴 관리</div>
    <div class="tab" data-tab="code">결제 코드</div>
  </div>

  <div id="pane-orders" class="card">
    <div class="row" style="justify-content:space-between">
      <div><b>주문목록</b></div>
      <button class="btn" id="exportOrders">엑셀 다운로드</button>
    </div>
    <table id="ordersTbl"><thead><tr><th>시간</th><th>테이블</th><th>항목</th><th>금액</th><th>상태</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="pane-qr" class="card hidden">
    <div class="row"><input id="qrTable" placeholder="테이블 번호"/> <button class="btn" id="makeQR">QR 생성</button> <a id="dlPng" class="btn" href="#" download="qr.png">PNG 다운로드</a></div>
    <div style="margin-top:10px"><img id="qrImg" style="background:#fff;border-radius:8px"/></div>
  </div>

  <div id="pane-menu" class="card hidden">
    <div class="row"><input id="m_id" placeholder="id"/><input id="m_name" placeholder="이름"/><input id="m_price" placeholder="가격" type="number"/><button class="btn" id="m_add">추가</button></div>
    <table id="menuTbl"><thead><tr><th>ID</th><th>이름</th><th>가격</th><th>활성</th><th>동작</th></tr></thead><tbody></tbody></table>
    <div class="row" style="margin-top:10px"><input type="file" id="xlsxFile"/><button class="btn" id="m_upload">엑셀 업로드</button></div>
  </div>

  <div id="pane-code" class="card hidden">
    <div class="row">
      <div>오늘의 결제 코드 <span id="dcDate" class="muted"></span></div>
      <span id="dcStatus" class="pill"></span>
      <span id="dcRemain" class="muted"></span>
    </div>
    <div class="row" style="margin-top:10px">
      <input id="dcCode" style="width:140px" readonly>
      <button class="btn" id="copyBtn">복사</button>
      <button class="btn" id="regenBtn">새 코드 발급</button>
      <button class="btn" id="clearBtn">기본 코드로 되돌리기</button>
    </div>
  </div>
</div>

<script>
let API='', ORDER_BASE='', TOKEN=localStorage.getItem('adminToken')||'';
function authHeaders(){ return { 'Content-Type':'application/json', 'Authorization':'Bearer '+TOKEN }; }
function api(p){ return API + p; }
function setTabActive(name){
  document.querySelectorAll('.tab').forEach(t=> t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
  document.querySelectorAll('[id^=pane-]').forEach(p=> p.classList.add('hidden'));
  document.getElementById('pane-'+name).classList.remove('hidden');
}
// tabs
document.querySelectorAll('.tab').forEach(t=> t.onclick=()=> setTabActive(t.dataset.tab));

document.getElementById('logoutBtn').onclick = ()=>{ localStorage.removeItem('adminToken'); TOKEN=''; location.href='/login'; };

async function init(){
  const r=await fetch('/admin-config'); const j=await r.json(); API=j.apiBase; ORDER_BASE=j.orderBase;
  if(!TOKEN){ /* not logged in: don't alert/pop; keep UI idle */ return; }
  // After login only: load data. Failures are shown minimally or silently.
  try{ await Promise.all([loadOrders(), loadMenu(), loadDailyCode()]); }catch(e){ console.warn('initial load error', e); }
}

// Orders
const ordersTbody = document.querySelector('#ordersTbl tbody');
function rowHtml(o){ const items=(o.items||[]).map(([id,q])=>`${id} x ${q}`).join(', '); return `<tr><td>${o.createdAt||''}</td><td>${o.tableNo||''}</td><td>${items}</td><td>${(o.amount||0).toLocaleString('ko-KR')}</td><td>${o.status||''}</td></tr>`; }
async function loadOrders(){ const r=await fetch(api('/orders')); if(!r.ok) return; const arr=await r.json(); ordersTbody.innerHTML=arr.map(rowHtml).join(''); }
(function sse(){ try{ const es=new EventSource(api('/events/orders')); es.addEventListener('order', e=>{ loadOrders(); }); }catch(_){ /* fallback by timer, but silent */ setInterval(loadOrders,15000); } })();
document.getElementById('exportOrders').onclick = ()=>{ if(!TOKEN){ location.href='/login'; return; } window.location.href = api('/export/orders.xlsx')+'?token='+TOKEN; };

// QR (ORDER_BASE/?table=)
document.getElementById('makeQR').onclick = ()=>{
  if(!TOKEN){ location.href='/login'; return; }
  const t=document.getElementById('qrTable').value||'';
  const link = ORDER_BASE + '/?table=' + encodeURIComponent(t);
  const apiQR = api('/qr?size=220x220&data='+encodeURIComponent(link));
  document.getElementById('qrImg').src = apiQR; document.getElementById('dlPng').href = apiQR;
};

// Menu (edit/save/delete/add)
const menuTbody = document.querySelector('#menuTbl tbody');
async function loadMenu(){ const r=await fetch(api('/menu')); if(!r.ok) return; const arr=await r.json(); menuTbody.innerHTML = arr.map(trHtml).join(''); }
function trHtml(m){
  return `<tr data-id="${m.id}">
    <td>${m.id}</td>
    <td><input value="${m.name||''}" class="m_name"></td>
    <td><input type="number" value="${m.price||0}" class="m_price" style="width:100px"></td>
    <td><input type="checkbox" class="m_active" ${m.active?'checked':''}></td>
    <td>
      <button class="btn m_save">저장</button>
      <button class="btn m_del">삭제</button>
    </td>
  </tr>`;
}
menuTbody.addEventListener('click', async (e)=>{
  const tr = e.target.closest('tr'); if(!tr) return;
  const id = tr.getAttribute('data-id');
  if(e.target.classList.contains('m_save')){
    if(!TOKEN){ location.href='/login'; return; }
    const name = tr.querySelector('.m_name').value.trim();
    const price = Number(tr.querySelector('.m_price').value||0);
    const active = tr.querySelector('.m_active').checked;
    const r = await fetch(api('/menu/'+encodeURIComponent(id)), { method:'PATCH', headers: authHeaders(), body: JSON.stringify({ name, price, active }) });
    if(!r.ok){ alert('저장 실패'); return; }
  }
  if(e.target.classList.contains('m_del')){
    if(!TOKEN){ location.href='/login'; return; }
    if(!confirm('삭제할까요?')) return;
    const r = await fetch(api('/menu/'+encodeURIComponent(id)), { method:'DELETE', headers: authHeaders() });
    if(!r.ok){ alert('삭제 실패'); return; }
    await loadMenu();
  }
});
document.getElementById('m_add').onclick = async ()=>{
  if(!TOKEN){ location.href='/login'; return; }
  const id=m_id.value.trim(), name=m_name.value.trim(), price=Number(m_price.value||0);
  if(!id || !name || !price){ alert('id, 이름, 가격을 입력해 주세요'); return; }
  const r=await fetch(api('/menu'), { method:'POST', headers: authHeaders(), body: JSON.stringify({ id,name,price,active:true }) });
  if(!r.ok){ const t=await r.text(); alert('추가 실패: '+t); return; }
  m_id.value=''; m_name.value=''; m_price.value=''; await loadMenu();
};

// Excel upload
document.getElementById('m_upload').onclick = async ()=>{
  if(!TOKEN){ location.href='/login'; return; }
  const f=document.getElementById('xlsxFile').files[0]; if(!f){ alert('파일 선택'); return; }
  const fd=new FormData(); fd.append('file', f);
  const r=await fetch(api('/import/menu'), { method:'POST', headers:{ 'Authorization': 'Bearer '+TOKEN }, body: fd });
  if(!r.ok){ alert('업로드 실패'); return; }
  await loadMenu();
};

// Daily Code (silent errors)
function untilMidnightText(){ const now=new Date(); const end=new Date(now); end.setHours(24,0,0,0); const ms=end-now; const h=Math.floor(ms/3600000); const m=Math.floor((ms%3600000)/60000); return `자정까지 ${h}시간 ${m}분`; }
function updateRemain(){ const el=document.getElementById('dcRemain'); if(el) el.textContent = untilMidnightText(); }
setInterval(updateRemain, 60000);
async function loadDailyCode(){
  if(!TOKEN) return;
  try{
    const r=await fetch(api('/daily-code'), { headers: authHeaders() });
    if(!r.ok) return; // silent
    const j=await r.json();
    dcDate.textContent='('+j.date+')'; dcCode.value=j.code;
    dcStatus.textContent=j.override?'오버라이드(오늘만)':'기본 코드'; dcStatus.className='pill '+(j.override?'warn':'ok');
    updateRemain();
  }catch(e){ /* silent */ }
}
regenBtn.onclick = async ()=>{ if(!TOKEN){ location.href='/login'; return; } const r=await fetch(api('/daily-code/regen'), { method:'POST', headers: authHeaders() }); if(r.ok){ await loadDailyCode(); alert('오늘의 새 코드가 발급되었습니다.'); } };
clearBtn.onclick = async ()=>{ if(!TOKEN){ location.href='/login'; return; } const r=await fetch(api('/daily-code/clear'), { method:'POST', headers: authHeaders() }); if(r.ok){ await loadDailyCode(); alert('기본 코드로 되돌렸습니다.'); } };
copyBtn.onclick = ()=>{ if(!TOKEN){ location.href='/login'; return; } navigator.clipboard?.writeText(dcCode.value).then(()=> alert('복사되었습니다.')); };

init();
</script>

<script>(function(){if(window.__QR_CTRL_511)return;window.__QR_CTRL_511=true;
function $(s,r){return(r||document).querySelector(s)}function $all(s,r){return Array.prototype.slice.call((r||document).querySelectorAll(s))}
function textOf(e){return(e&&(e.textContent||e.value||'')).replace(/^\s+|\s+$/g,'')}function visible(e){return e&&e.offsetParent!==null&&!e.disabled}
function now(){return (new Date()).getTime()}
function findQrCard(){var h=$all('h1,h2,h3,h4'),i,x=null;for(i=0;i<h.length;i++){if(/QR\s*배포/.test(textOf(h[i]))){x=h[i];break}}if(!x){for(i=0;i<h.length;i++){if(/QR\s*생성/.test(textOf(h[i]))){x=h[i];break}}}return x?((x.closest&&(x.closest('.card')||x.parentElement))||x.parentElement):document.body}
function findGenBtn(c){var b=$all('button,a,input[type=button]',c),i;for(i=0;i<b.length;i++){if(/QR\s*생성/i.test(textOf(b[i])))return b[i]}for(i=0;i<b.length;i++){if(/(생성|generate|create)/i.test(textOf(b[i])))return b[i]}return null}
function ensureUI(c){
  var g=findGenBtn(c);
  var w=$('#qrPreviewDet',c); if(!w){w=document.createElement('div');w.id='qrPreviewDet'; if(g&&g.parentNode) g.parentNode.parentNode.insertBefore(w,g.parentNode.nextSibling); else c.insertBefore(w,c.firstChild)}
  var cv=$('#qrPreviewCanvas',w); if(!cv){cv=document.createElement('canvas');cv.id='qrPreviewCanvas'; cv.setAttribute('aria-hidden','true'); w.appendChild(cv)}
  var im=$('#qrPreviewImg',w); if(!im){im=document.createElement('img');im.id='qrPreviewImg'; im.setAttribute('aria-hidden','true'); w.appendChild(im)}
  var hint=$('#qrPreviewHint',w); if(!hint){hint=document.createElement('div');hint.id='qrPreviewHint'; hint.appendChild(document.createTextNode('QR 생성 버튼을 누르면 미리보기가 표시됩니다.')); w.appendChild(hint)}
  var t=$('h4[data-det-saved]',c); if(!t){t=document.createElement('h4');t.setAttribute('data-det-saved','1'); t.appendChild(document.createTextNode('저장된 QR')); w.parentNode.insertBefore(t,w.nextSibling)}
  var grid=$('#qrSavedList',c); if(!grid){grid=document.createElement('div');grid.id='qrSavedList';grid.className='qr-grid'; t.parentNode.insertBefore(grid,t.nextSibling)}
  var save=$('#btnQrSaveTop',c); if(!save){save=document.createElement('button');save.id='btnQrSaveTop';save.className=g?(g.className||'btn'):'btn';save.appendChild(document.createTextNode('QR 저장')); if(g&&g.parentNode){var p=g.parentNode; if(g.nextSibling)p.insertBefore(save,g.nextSibling.nextSibling||g.nextSibling); else p.appendChild(save)} else c.insertBefore(save,c.firstChild)}
  try{
    var savedSection=t.parentNode; 
    var kids=$all(':scope > *', savedSection);
    for(var i=0;i<kids.length;i++){
      var k=kids[i];
      if(k.id==='qrSavedList' || k===t) continue;
      var hasButtons=$all('button',k).some(function(b){var s=textOf(b);return /다운로드|삭제/.test(s)});
      var hasImg=$all('img,canvas,svg',k).length>0;
      if(hasButtons && !hasImg){ k.classList.add('qr-legacy-hide'); }
    }
  }catch(e){}
  return {genBtn:g,saveBtn:save,canvas:cv,img:im,grid:grid,hint:hint}
}
function sizeInfo(n){
  var w=0,h=0; if(n.getBoundingClientRect){ var r=n.getBoundingClientRect(); w=r.width; h=r.height; }
  if(!(w>0 && h>0)){
    if(n.tagName==='IMG'){ w=n.naturalWidth||0; h=n.naturalHeight||0; }
    else if(n.tagName==='CANVAS'){ w=n.width||0; h=n.height||0; }
    else if(n.tagName && n.tagName.toLowerCase()==='svg'){
      try{
        if(n.viewBox && n.viewBox.baseVal){ w=n.viewBox.baseVal.width||0; h=n.viewBox.baseVal.height||0; }
        if(!(w>0 && h>0)){ if(n.width && n.width.baseVal) w=n.width.baseVal.value||0; if(n.height && n.height.baseVal) h=n.height.baseVal.value||0; }
      }catch(e){}
    }
  }
  if(!(w>0 && h>0)){ w=256; h=256; }
  var area=Math.max(1,w*h); var ratio=(w&&h)?(w/h):1; var square=1-Math.min(1,Math.abs(1-ratio));
  return {area:area, score: area*(0.7+0.3*square)};
}
function findRealQR(c){
  var nodes=$all('canvas, img, svg',c).filter(function(n){
    var isHidden=n.classList.contains('qr-hidden-source');
    if(isHidden) return true;
    return visible(n) && n.id!=='qrPreviewCanvas' && n.id!=='qrPreviewImg' && !n.closest('#qrPreviewDet');
  });
  var best=null,score=0,i; for(i=0;i<nodes.length;i++){ var s=sizeInfo(nodes[i]); if(s.score>score){ best=nodes[i]; score=s.score; } }
  return best;
}
function showOnly(el){ el.style.display='block'; el.setAttribute('aria-hidden','false'); }
function hide(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }
function showPreviewFrom(el,ui){
  hide(ui.canvas); hide(ui.img); ui.hint.style.display='none';
  if(!el){ ui.hint.style.display='block'; return {kind:'none'}; }
  if(el.tagName==='CANVAS'){
    var rect=ui.canvas.getBoundingClientRect(); var size=Math.max(200,Math.min(320,Math.round(rect.width||256)));
    ui.canvas.width=size; ui.canvas.height=size;
    var w=el.width||256,h=el.height||256,sc=Math.min(size/w,size/h); var dw=Math.round(w*sc),dh=Math.round(h*sc);
    var ctx=ui.canvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,size,size);
    try{ ctx.drawImage(el, Math.round((size-dw)/2), Math.round((size-dh)/2), dw, dh); showOnly(ui.canvas); el.classList.add('qr-hidden-source'); return {kind:'canvas'} }catch(e){}
  }
  if(el.tagName==='IMG'){ try{ ui.img.src=el.src; showOnly(ui.img); el.classList.add('qr-hidden-source'); return {kind:'img',src:el.src} }catch(e){ ui.hint.style.display='block'; return {kind:'none'}; } }
  if(el.tagName && el.tagName.toLowerCase()==='svg'){ try{ var s=(new XMLSerializer()).serializeToString(el); var enc='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(s); ui.img.src=enc; showOnly(ui.img); el.classList.add('qr-hidden-source'); return {kind:'svg',src:enc} }catch(e){ ui.hint.style.display='block'; return {kind:'none'}; } }
  ui.hint.style.display='block'; return {kind:'none'};
}
function getList(){ try{return JSON.parse(localStorage.getItem('__qr_saved_list')||'[]')}catch(e){return[]} }
function setList(l){ localStorage.setItem('__qr_saved_list', JSON.stringify(l)); }
function getQrUrlBuilder(card){
  try{
    var imgs=$all('img',card).concat($all('img',document.body));
    var cand=imgs.find(function(im){ var s=im.getAttribute('src')||''; return /(?:^|\\/|\\?)qr(?:\\?|$)/i.test(s); });
    if(!cand) return null;
    var u=new URL(cand.src, location.href);
    var params=new URLSearchParams(u.search);
    var key= params.has('table')?'table':(params.has('t')?'t':'table');
    return function(table, size){
      var u2=new URL(u.href);
      var p=new URLSearchParams(u2.search);
      p.set(key, String(table));
      if(size){ p.set('size', String(size)); }
      u2.search='?'+p.toString();
      return u2.toString();
    }
  }catch(e){ return null; }
}
function healMissing(list, card){
  var build=getQrUrlBuilder(card);
  if(!build) return list;
  var changed=false;
  for(var i=0;i<list.length;i++){
    var it=list[i];
    if(!it.dataUrl && !it.url && it.table){
      it.url = build(it.table, 220); changed=true;
    }
  }
  if(changed) setList(list);
  return list;
}
function render(grid, card){
  var list=getList();
  list = healMissing(list, card);
  if(!list.length){ grid.innerHTML='<div class="small" style="opacity:.7">저장된 QR이 없습니다. QR 생성 후 [QR 저장]을 눌러 추가하세요.</div>'; return; }
  grid.innerHTML='';
  for(var i=0;i<list.length;i++){
    var it=list[i]; var cd=document.createElement('div'); cd.className='qr-card';
    var img=document.createElement('img'); img.src=(it.dataUrl||it.url||''); img.alt='QR '+(it.table||'');
    var meta=document.createElement('div'); meta.className='qr-meta'; meta.appendChild(document.createTextNode('테이블 '+(it.table||'')));
    var acts=document.createElement('div'); acts.className='qr-actions';
    var dl=document.createElement('button'); dl.className='btn'; dl.appendChild(document.createTextNode('다운로드'));
    if(it.dataUrl){ dl.onclick=(function(u,t,idx){return function(){ var a=document.createElement('a'); a.href=u; a.download='qr_table_'+(t||idx)+'.png'; a.click(); }})(it.dataUrl,it.table,i); }
    else if(it.url){ dl.onclick=(function(u){ return function(){ var a=document.createElement('a'); a.href=u; a.target='_blank'; a.rel='noopener'; a.click(); };})(it.url); }
    else { dl.disabled=true; }
    var rm=document.createElement('button'); rm.className='btn'; rm.appendChild(document.createTextNode('삭제'));
    rm.onclick=(function(idx){ return function(){ var l=getList().filter(function(_,j){return j!==idx}); setList(l); render(grid, card); };})(i);
    acts.appendChild(dl); acts.appendChild(rm); cd.appendChild(img); cd.appendChild(meta); cd.appendChild(acts); grid.appendChild(cd);
  }
}
function wirePreviewDownload(card,ui){
  var link=null, els=$all('a,button',card), i; for(i=0;i<els.length;i++){ if(/PNG\\s*다운로드/i.test(textOf(els[i]))){ link=els[i]; break; } }
  if(!link) return;
  link.addEventListener('click', function(ev){
    ev.preventDefault(); ev.stopPropagation();
    if(ui.canvas.style.display==='block'){ try{ var d=ui.canvas.toDataURL('image/png'); var a=document.createElement('a'); a.href=d; a.download='qr_preview.png'; a.click(); return; }catch(e){} }
    if(ui.img.style.display==='block' && ui.img.src){ var a2=document.createElement('a'); a2.href=ui.img.src; a2.target='_blank'; a2.rel='noopener'; a2.click(); }
  }, true);
}
document.addEventListener('DOMContentLoaded', function(){
  var card=findQrCard(); var ui=ensureUI(card);
  function sync(){ var src=findRealQR(card); showPreviewFrom(src, ui); wirePreviewDownload(card, ui); }
  var mo=new MutationObserver(function(){ setTimeout(sync, 40); }); mo.observe(card, {childList:true, subtree:true});
  var g=findGenBtn(card); if(g){ g.addEventListener('click', function(){ setTimeout(sync, 80); }); }
  ui.saveBtn.addEventListener('click', function(){
    sync();
    setTimeout(function(){
      var gen=findGenBtn(card);
      var input=(function(){ if(gen&&gen.parentNode){ var p=gen.previousElementSibling, hop=0; while(p&&hop<4){ if(p.tagName&&p.tagName.toUpperCase()==='INPUT'&&visible(p)) return p; var c=$('input',p); if(c&&visible(c)) return c; p=p.previousElementSibling; hop++; } var cand=$all('input',gen.parentNode).filter(visible)[0]; if(cand) return cand; } var c2=$all('input[type=number],input[type=text]', card).filter(visible)[0]; return c2 || null; })();
      var val=(input&&input.value||'').replace(/^\s+|\s+$/g,''); if(!val){ alert('테이블 번호를 입력하세요'); return; }
      if(ui.canvas.style.display==='block'){ try{ var dataUrl=ui.canvas.toDataURL('image/png'); var list=getList(); var i,idx=-1; for(i=0;i<list.length;i++){ if(String(list[i].table||'')===String(val)){ idx=i; break; } } var item={table:String(val), dataUrl:dataUrl, ts:now()}; if(idx>=0) list[idx]=item; else list.push(item); setList(list); render(ui.grid, card); return; }catch(e){} }
      if(ui.img.style.display==='block' && ui.img.src){ var list2=getList(); var j,jdx=-1; for(j=0;j<list2.length;j++){ if(String(list2[j].table||'')===String(val)){ jdx=j; break; } } var item2={table:String(val), url:ui.img.src, ts:now()}; if(jdx>=0) list2[jdx]=item2; else list2.push(item2); setList(list2); render(ui.grid, card); return; }
      alert('먼저 QR 생성 버튼을 눌러 미리보기를 확인하세요.');
    }, 120);
  });
  render(ui.grid, card); sync();
});
})();</script>


<script>(function(){if(window.__FORM_ID_FIX_511)return;window.__FORM_ID_FIX_511=true;
function visible(el){return el && el.offsetParent!==null && !el.disabled}
document.addEventListener('DOMContentLoaded',function(){
  var n=0; var nodes=document.querySelectorAll('input,select,textarea');
  for (var i=0;i<nodes.length;i++){
    var el=nodes[i]; if(!visible(el)) continue; if (el.id) continue;
    var base=(el.getAttribute('name')||el.getAttribute('aria-label')||el.type||'field').toString().replace(/[^a-z0-9_\-]/ig,'_'); if(!base) base='field';
    var candidate=base+'_'+(++n); while(document.getElementById(candidate)){ candidate=base+'_'+(++n); }
    el.id=candidate;
  }
});})();</script>

</body></html>
