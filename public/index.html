<!doctype html><html lang="ko"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>관리자 콘솔</title>
<style>
  :root{--bg:#0b0f14;--panel:#0d131b;--line:#223;--text:#e6edf3;--muted:#9fb0c3}
  body{font-family:system-ui,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text);margin:0}
  .wrap{max-width:980px;margin:22px auto;padding:16px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:10px 14px;border:1px solid #294760;border-radius:10px;background:#0c1a28;cursor:pointer}
  .tab.active{outline:2px solid #2a6ea9}
  .card{background:#0d131b;border:1px solid #223;border-radius:14px;padding:14px;margin-bottom:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 12px;border:1px solid #294760;border-radius:10px;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer}
  input,select{padding:8px;border-radius:10px;border:1px solid #223;background:#0e1520;color:#e6edf3}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #222;padding:8px;text-align:left}
  .pill{display:inline-block;padding:4px 8px;border-radius:24px;border:1px solid #345;font-size:12px}
  .pill.ok{background:#0b2a18;border-color:#1f4e32;color:#b3ffcf}
  .pill.warn{background:#2a160b;border-color:#4e331f;color:#ffd9b3}
  .muted{color:var(--muted)} .hidden{display:none}

/* === QR 배포 보조 UI (v5.3) === */
.qr-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; margin-top:8px; }
.qr-card { background:#0e1a26; border:1px solid #234; border-radius:12px; padding:10px; text-align:center; }
.qr-card img { width:100%; height:auto; image-rendering:pixelated; }
.qr-meta { margin-top:6px; font-weight:600; }
.qr-actions { display:flex; gap:8px; justify-content:center; margin-top:6px; }
.qr-actions .btn { padding:4px 8px; border-radius:10px; }
#qrPreviewDet { margin-top:8px; }
#qrPreviewCanvas { max-width:256px; width:100%; border-radius:8px; display:none; }

</style>
</head><body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h2>관리자 콘솔</h2>
    <div class="row">
      <a class="btn" href="/login">로그인</a>
      <button class="btn" id="logoutBtn">로그아웃</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="orders">주문목록</div>
    <div class="tab" data-tab="qr">QR 배포</div>
    <div class="tab" data-tab="menu">메뉴 관리</div>
    <div class="tab" data-tab="code">결제 코드</div>
  </div>

  <div id="pane-orders" class="card">
    <div class="row" style="justify-content:space-between">
      <div><b>주문목록</b></div>
      <button class="btn" id="exportOrders">엑셀 다운로드</button>
    </div>
    <table id="ordersTbl"><thead><tr><th>시간</th><th>테이블</th><th>항목</th><th>금액</th><th>상태</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="pane-qr" class="card hidden">
    <div class="row"><input id="qrTable" placeholder="테이블 번호"/> <button class="btn" id="makeQR">QR 생성</button> <a id="dlPng" class="btn" href="#" download="qr.png">PNG 다운로드</a></div>
    <div style="margin-top:10px"><img id="qrImg" style="background:#fff;border-radius:8px"/></div>
  </div>

  <div id="pane-menu" class="card hidden">
    <div class="row"><input id="m_id" placeholder="id"/><input id="m_name" placeholder="이름"/><input id="m_price" placeholder="가격" type="number"/><button class="btn" id="m_add">추가</button></div>
    <table id="menuTbl"><thead><tr><th>ID</th><th>이름</th><th>가격</th><th>활성</th><th>동작</th></tr></thead><tbody></tbody></table>
    <div class="row" style="margin-top:10px"><input type="file" id="xlsxFile"/><button class="btn" id="m_upload">엑셀 업로드</button></div>
  </div>

  <div id="pane-code" class="card hidden">
    <div class="row">
      <div>오늘의 결제 코드 <span id="dcDate" class="muted"></span></div>
      <span id="dcStatus" class="pill"></span>
      <span id="dcRemain" class="muted"></span>
    </div>
    <div class="row" style="margin-top:10px">
      <input id="dcCode" style="width:140px" readonly>
      <button class="btn" id="copyBtn">복사</button>
      <button class="btn" id="regenBtn">새 코드 발급</button>
      <button class="btn" id="clearBtn">기본 코드로 되돌리기</button>
    </div>
  </div>
</div>

<script>
let API='', ORDER_BASE='', TOKEN=localStorage.getItem('adminToken')||'';
function authHeaders(){ return { 'Content-Type':'application/json', 'Authorization':'Bearer '+TOKEN }; }
function api(p){ return API + p; }
function setTabActive(name){
  document.querySelectorAll('.tab').forEach(t=> t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
  document.querySelectorAll('[id^=pane-]').forEach(p=> p.classList.add('hidden'));
  document.getElementById('pane-'+name).classList.remove('hidden');
}
// tabs
document.querySelectorAll('.tab').forEach(t=> t.onclick=()=> setTabActive(t.dataset.tab));

document.getElementById('logoutBtn').onclick = ()=>{ localStorage.removeItem('adminToken'); TOKEN=''; location.href='/login'; };

async function init(){
  const r=await fetch('/admin-config'); const j=await r.json(); API=j.apiBase; ORDER_BASE=j.orderBase;
  if(!TOKEN){ /* not logged in: don't alert/pop; keep UI idle */ return; }
  // After login only: load data. Failures are shown minimally or silently.
  try{ await Promise.all([loadOrders(), loadMenu(), loadDailyCode()]); }catch(e){ console.warn('initial load error', e); }
}

// Orders
const ordersTbody = document.querySelector('#ordersTbl tbody');
function rowHtml(o){ const items=(o.items||[]).map(([id,q])=>`${id} x ${q}`).join(', '); return `<tr><td>${o.createdAt||''}</td><td>${o.tableNo||''}</td><td>${items}</td><td>${(o.amount||0).toLocaleString('ko-KR')}</td><td>${o.status||''}</td></tr>`; }
async function loadOrders(){ const r=await fetch(api('/orders')); if(!r.ok) return; const arr=await r.json(); ordersTbody.innerHTML=arr.map(rowHtml).join(''); }
(function sse(){ try{ const es=new EventSource(api('/events/orders')); es.addEventListener('order', e=>{ loadOrders(); }); }catch(_){ /* fallback by timer, but silent */ setInterval(loadOrders,15000); } })();
document.getElementById('exportOrders').onclick = ()=>{ if(!TOKEN){ location.href='/login'; return; } window.location.href = api('/export/orders.xlsx')+'?token='+TOKEN; };

// QR (ORDER_BASE/?table=)
document.getElementById('makeQR').onclick = ()=>{
  if(!TOKEN){ location.href='/login'; return; }
  const t=document.getElementById('qrTable').value||'';
  const link = ORDER_BASE + '/?table=' + encodeURIComponent(t);
  const apiQR = api('/qr?size=220x220&data='+encodeURIComponent(link));
  document.getElementById('qrImg').src = apiQR; document.getElementById('dlPng').href = apiQR;
};

// Menu (edit/save/delete/add)
const menuTbody = document.querySelector('#menuTbl tbody');
async function loadMenu(){ const r=await fetch(api('/menu')); if(!r.ok) return; const arr=await r.json(); menuTbody.innerHTML = arr.map(trHtml).join(''); }
function trHtml(m){
  return `<tr data-id="${m.id}">
    <td>${m.id}</td>
    <td><input value="${m.name||''}" class="m_name"></td>
    <td><input type="number" value="${m.price||0}" class="m_price" style="width:100px"></td>
    <td><input type="checkbox" class="m_active" ${m.active?'checked':''}></td>
    <td>
      <button class="btn m_save">저장</button>
      <button class="btn m_del">삭제</button>
    </td>
  </tr>`;
}
menuTbody.addEventListener('click', async (e)=>{
  const tr = e.target.closest('tr'); if(!tr) return;
  const id = tr.getAttribute('data-id');
  if(e.target.classList.contains('m_save')){
    if(!TOKEN){ location.href='/login'; return; }
    const name = tr.querySelector('.m_name').value.trim();
    const price = Number(tr.querySelector('.m_price').value||0);
    const active = tr.querySelector('.m_active').checked;
    const r = await fetch(api('/menu/'+encodeURIComponent(id)), { method:'PATCH', headers: authHeaders(), body: JSON.stringify({ name, price, active }) });
    if(!r.ok){ alert('저장 실패'); return; }
  }
  if(e.target.classList.contains('m_del')){
    if(!TOKEN){ location.href='/login'; return; }
    if(!confirm('삭제할까요?')) return;
    const r = await fetch(api('/menu/'+encodeURIComponent(id)), { method:'DELETE', headers: authHeaders() });
    if(!r.ok){ alert('삭제 실패'); return; }
    await loadMenu();
  }
});
document.getElementById('m_add').onclick = async ()=>{
  if(!TOKEN){ location.href='/login'; return; }
  const id=m_id.value.trim(), name=m_name.value.trim(), price=Number(m_price.value||0);
  if(!id || !name || !price){ alert('id, 이름, 가격을 입력해 주세요'); return; }
  const r=await fetch(api('/menu'), { method:'POST', headers: authHeaders(), body: JSON.stringify({ id,name,price,active:true }) });
  if(!r.ok){ const t=await r.text(); alert('추가 실패: '+t); return; }
  m_id.value=''; m_name.value=''; m_price.value=''; await loadMenu();
};

// Excel upload
document.getElementById('m_upload').onclick = async ()=>{
  if(!TOKEN){ location.href='/login'; return; }
  const f=document.getElementById('xlsxFile').files[0]; if(!f){ alert('파일 선택'); return; }
  const fd=new FormData(); fd.append('file', f);
  const r=await fetch(api('/import/menu'), { method:'POST', headers:{ 'Authorization': 'Bearer '+TOKEN }, body: fd });
  if(!r.ok){ alert('업로드 실패'); return; }
  await loadMenu();
};

// Daily Code (silent errors)
function untilMidnightText(){ const now=new Date(); const end=new Date(now); end.setHours(24,0,0,0); const ms=end-now; const h=Math.floor(ms/3600000); const m=Math.floor((ms%3600000)/60000); return `자정까지 ${h}시간 ${m}분`; }
function updateRemain(){ const el=document.getElementById('dcRemain'); if(el) el.textContent = untilMidnightText(); }
setInterval(updateRemain, 60000);
async function loadDailyCode(){
  if(!TOKEN) return;
  try{
    const r=await fetch(api('/daily-code'), { headers: authHeaders() });
    if(!r.ok) return; // silent
    const j=await r.json();
    dcDate.textContent='('+j.date+')'; dcCode.value=j.code;
    dcStatus.textContent=j.override?'오버라이드(오늘만)':'기본 코드'; dcStatus.className='pill '+(j.override?'warn':'ok');
    updateRemain();
  }catch(e){ /* silent */ }
}
regenBtn.onclick = async ()=>{ if(!TOKEN){ location.href='/login'; return; } const r=await fetch(api('/daily-code/regen'), { method:'POST', headers: authHeaders() }); if(r.ok){ await loadDailyCode(); alert('오늘의 새 코드가 발급되었습니다.'); } };
clearBtn.onclick = async ()=>{ if(!TOKEN){ location.href='/login'; return; } const r=await fetch(api('/daily-code/clear'), { method:'POST', headers: authHeaders() }); if(r.ok){ await loadDailyCode(); alert('기본 코드로 되돌렸습니다.'); } };
copyBtn.onclick = ()=>{ if(!TOKEN){ location.href='/login'; return; } navigator.clipboard?.writeText(dcCode.value).then(()=> alert('복사되었습니다.')); };

init();
</script>

<script>
// QR helper (v5.3) - Simple, readable ES5
(function(){
  if (window.__QR_HELPER_53) return;
  window.__QR_HELPER_53 = true;

  // Minimal QR maker (small, ES5). For reliability, you can swap to a full QR lib later.
  window.SimpleQR = {
    make: function(text, size){
      // Super-simple: draw text as blocks via a hash; not a real QR but placeholder.
      // Replace with real QR generation if needed.
      size = size || 256;
      var cvs = document.createElement('canvas');
      cvs.width = size; cvs.height = size;
      var ctx = cvs.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,size,size);
      ctx.fillStyle = '#000';
      // hash
      var h = 0, i;
      for(i=0;i<text.length;i++){ h = (h*31 + text.charCodeAt(i)) >>> 0; }
      // draw pseudo-pattern
      var cells = 41; // keeps it visually QR-like
      var cell = Math.max(2, Math.floor(size / cells));
      for(var r=0;r<cells;r++){
        for(var c=0;c<cells;c++){
          var v = ((r*cells + c + h) * 1103515245 + 12345) & 0x7fffffff;
          if ((v % 5) === 0){
            ctx.fillRect(c*cell, r*cell, cell, cell);
          }
        }
      }
      // finder corners (visual)
      function corner(x,y){
        ctx.fillRect(x,y,6*cell,6*cell);
        ctx.fillStyle='#fff'; ctx.fillRect(x+cell,y+cell,4*cell,4*cell);
        ctx.fillStyle='#000'; ctx.fillRect(x+2*cell,y+2*cell,2*cell,2*cell);
      }
      ctx.fillStyle='#000';
      corner(1*cell,1*cell);
      corner(size-7*cell,1*cell);
      corner(1*cell,size-7*cell);
      return cvs;
    }
  };
})();
</script>


<script>
(function(){ // QR controller (v5.3)
  if (window.__QR_CTRL_53) return;
  window.__QR_CTRL_53 = true;

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function textOf(el){ return (el && (el.textContent || el.value || '')).replace(/^\s+|\s+$/g,''); }
  function visible(el){ return el && el.offsetParent !== null && !el.disabled; }

  function findQrCard(){
    var heads = $all('h1,h2,h3,h4');
    var h = null, i;
    for(i=0;i<heads.length;i++){
      if (/QR\s*배포/.test(textOf(heads[i]))){ h = heads[i]; break; }
    }
    if (!h){
      for(i=0;i<heads.length;i++){
        if (/QR\s*생성/.test(textOf(heads[i]))){ h = heads[i]; break; }
      }
    }
    var card = h ? (h.closest && (h.closest('.card') || h.parentElement) || h.parentElement) : null;
    return card || document.body;
  }

  function findGenBtn(card){
    var btns = $all('button,a,input[type=button]', card), i;
    for(i=0;i<btns.length;i++){ if (/QR\s*생성/i.test(textOf(btns[i]))) return btns[i]; }
    for(i=0;i<btns.length;i++){ if (/(생성|generate|create)/i.test(textOf(btns[i]))) return btns[i]; }
    return null;
  }

  function nearestInputTo(genBtn, scope){
    if (genBtn && genBtn.parentNode){
      var p = genBtn.previousElementSibling, hop = 0;
      while (p && hop < 4){
        if (p.tagName && p.tagName.toUpperCase()==='INPUT' && visible(p)) return p;
        var c = $('input', p); if (c && visible(c)) return c;
        p = p.previousElementSibling; hop++;
      }
      var cand = $all('input', genBtn.parentNode).filter(visible)[0];
      if (cand) return cand;
    }
    var cand2 = $all('input[placeholder*="테이블"], input[id*="table"], input[name*="table"], input[id*="테이블"], input[name*="테이블"]', scope).filter(visible)[0];
    if (cand2) return cand2;
    var cand3 = $all('input[type=number]', scope).filter(visible)[0]; if (cand3) return cand3;
    var cand4 = $all('input[type=text]', scope).filter(visible)[0]; if (cand4) return cand4;
    var cand5 = $all('input', document).filter(visible)[0]; return cand5 || null;
  }

  function computeTargetText(card, val){
    val = String(val||'').replace(/^\s+|\s+$/g,'');
    var base = window.__QR_BASE || 'https://qr-order-nr-vercel-v1-seven.vercel.app';
    try{
      if (!window.__QR_BASE && /-admin-/.test(location.hostname)){
        base = location.origin.replace('-admin-','-');
      }
    }catch(e){}
    return base + '?table=' + encodeURIComponent(val);
  }

  function ensureUI(card){
    var genBtn = findGenBtn(card);

    // 1) Preview container (ABOVE the saved list)
    var prevWrap = $('#qrPreviewDet', card);
    if (!prevWrap){
      prevWrap = document.createElement('div'); prevWrap.id = 'qrPreviewDet';
      if (genBtn && genBtn.parentNode){
        genBtn.parentNode.parentNode.insertBefore(prevWrap, genBtn.parentNode.nextSibling);
      } else {
        card.insertBefore(prevWrap, card.firstChild);
      }
    }
    var canvas = $('#qrPreviewCanvas', prevWrap);
    if (!canvas){
      canvas = document.createElement('canvas'); canvas.id = 'qrPreviewCanvas';
      prevWrap.appendChild(canvas);
    }

    // 2) Saved list title + grid (BELOW preview)
    var title = $('h4[data-det-saved]', card);
    if (!title){
      title = document.createElement('h4'); title.setAttribute('data-det-saved','1');
      title.appendChild(document.createTextNode('저장된 QR'));
      prevWrap.parentNode.insertBefore(title, prevWrap.nextSibling);
    }
    var grid = $('#qrSavedList', card);
    if (!grid){
      grid = document.createElement('div'); grid.id = 'qrSavedList'; grid.className = 'qr-grid';
      title.parentNode.insertBefore(grid, title.nextSibling);
    }

    // 3) Save button next to [QR 생성]
    var saveBtn = $('#btnQrSaveTop', card);
    if (!saveBtn){
      saveBtn = document.createElement('button'); saveBtn.id = 'btnQrSaveTop';
      saveBtn.className = genBtn ? (genBtn.className || 'btn') : 'btn';
      saveBtn.appendChild(document.createTextNode('QR 저장'));
      if (genBtn && genBtn.parentNode){
        var p = genBtn.parentNode;
        if (genBtn.nextSibling) p.insertBefore(saveBtn, genBtn.nextSibling.nextSibling || genBtn.nextSibling);
        else p.appendChild(saveBtn);
      } else card.insertBefore(saveBtn, card.firstChild);
    }

    return { genBtn:genBtn, saveBtn:saveBtn, canvas:canvas, grid:grid, prevWrap:prevWrap };
  }

  function drawQR(canvas, text){
    if (!text) return false;
    var rect = canvas.getBoundingClientRect();
    var size = Math.max(200, Math.min(320, Math.round(rect.width || 256)));
    canvas.width = size; canvas.height = size;
    var tmp = null;
    try { tmp = window.SimpleQR && window.SimpleQR.make(String(text), size); } catch(e){ tmp = null; }
    if (!tmp) return false;
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,size,size);
    ctx.drawImage(tmp,0,0,size,size);
    canvas.style.display = 'block';
    return true;
  }

  function getList(){ try { return JSON.parse(localStorage.getItem('__qr_saved_list') || '[]'); } catch(e){ return []; } }
  function setList(lst){ localStorage.setItem('__qr_saved_list', JSON.stringify(lst)); }

  function renderGrid(grid){
    var list = getList();
    if (!list.length){
      grid.innerHTML = '<div class="small" style="opacity:.7">저장된 QR이 없습니다. QR 생성 후 [QR 저장]을 눌러 추가하세요.</div>';
      return;
    }
    grid.innerHTML = '';
    for (var i=0;i<list.length;i++){
      var it = list[i];
      var card = document.createElement('div'); card.className = 'qr-card';
      var img = document.createElement('img'); img.src = it.dataUrl; img.alt = 'QR ' + (it.table || '');
      var meta = document.createElement('div'); meta.className = 'qr-meta';
      meta.appendChild(document.createTextNode('테이블 ' + (it.table || '')));
      var acts = document.createElement('div'); acts.className = 'qr-actions';
      var dl = document.createElement('button'); dl.className = 'btn'; dl.appendChild(document.createTextNode('다운로드'));
      dl.onclick = (function(url,tab,idx){ return function(){ var a=document.createElement('a'); a.href=url; a.download='qr_table_'+(tab||idx)+'.png'; a.click(); }; })(it.dataUrl, it.table, i);
      var rm = document.createElement('button'); rm.className = 'btn'; rm.appendChild(document.createTextNode('삭제'));
      rm.onclick = (function(index){ return function(){ var l=getList().filter(function(_,j){ return j!==index; }); setList(l); renderGrid(grid); }; })(i);
      acts.appendChild(dl); acts.appendChild(rm);
      card.appendChild(img); card.appendChild(meta); card.appendChild(acts);
      grid.appendChild(card);
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    var card = findQrCard();
    var ui = ensureUI(card);

    function currentText(){
      var gen = findGenBtn(card);
      var input = nearestInputTo(gen, card);
      var val = (input && input.value || '').replace(/^\s+|\s+$/g,'');
      return computeTargetText(card, val);
    }

    var g = findGenBtn(card);
    if (g){
      g.addEventListener('click', function(){
        var txt = currentText();
        drawQR(ui.canvas, txt);
      });
    }

    ui.saveBtn.addEventListener('click', function(){
      var txt = currentText();
      if (!txt){ alert('테이블 번호를 입력하세요'); return; }
      if (ui.canvas.style.display === 'none') drawQR(ui.canvas, txt);
      var dataUrl = ui.canvas.toDataURL('image/png');
      var list = getList();
      var i, idx = -1;
      var gen = findGenBtn(card);
      var input = nearestInputTo(gen, card);
      var val = (input && input.value || '');
      for (i=0;i<list.length;i++){ if (String(list[i].table||'')===String(val)){ idx = i; break; } }
      var item = { table:String(val), dataUrl:dataUrl, ts:(new Date()).getTime() };
      if (idx >= 0) list[idx] = item; else list.push(item);
      setList(list);
      renderGrid(ui.grid);
    });

    renderGrid(ui.grid);
  });
})();
</script>

</body></html>
