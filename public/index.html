<!doctype html><html lang="ko"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>관리자 콘솔</title>
<style>
  :root{--bg:#0b0f14;--panel:#0d131b;--line:#223;--text:#e6edf3;--muted:#9fb0c3}
  body{font-family:system-ui,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text);margin:0}
  .wrap{max-width:1100px;margin:22px auto;padding:16px}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:10px 14px;border:1px solid #294760;border-radius:10px;background:#0c1a28;cursor:pointer}
  .tab.active{outline:2px solid #2a6ea9}
  .card{background:#0d131b;border:1px solid #223;border-radius:14px;padding:14px;margin-bottom:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 12px;border:1px solid #294760;border-radius:12px;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer}
  input,select{padding:8px;border-radius:10px;border:1px solid #223;background:#0e1520;color:#e6edf3}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #222;padding:8px;text-align:left;vertical-align:top}
  .pill{display:inline-block;padding:4px 8px;border-radius:24px;border:1px solid #345;font-size:12px}
  .muted{color:#9fb0c3}.hidden{display:none}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .tile{border:1px solid #223;border-radius:12px;padding:10px;background:#0e1520}
</style>
</head><body>
<div class="wrap">
  <div class="top">
    <div><b>관리자 콘솔</b></div>
    <div class="row">
      <a class="btn" id="homeBtn" href="/" >홈</a>
      <a class="btn" id="loginBtn" href="/login">로그인</a>
      <button class="btn hidden" id="logoutBtn">로그아웃</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="orders">주문목록</div>
    <div class="tab" data-tab="tables">테이블</div>
    <div class="tab" data-tab="qr">QR 배포</div>
    <div class="tab" data-tab="menu">메뉴 관리</div>
    <div class="tab" data-tab="code">결제 코드</div>
    <div class="tab" data-tab="stats">통계</div>
  </div>

  <div id="pane-orders" class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:14px">
        <b>주문목록</b>
        <label class="row">상태
          <select id="filterStatus">
            <option value="">전체</option>
            <option>접수</option><option>준비중</option><option>완료</option><option>취소</option><option>환불</option>
          </select>
        </label>
      </div>
      <div class="row">
        <button class="btn" id="exportOrders">엑셀 다운로드</button>
        <label class="row">알림
          <select id="notifyMode">
            <option value="sound">소리</option>
            <option value="browser">브라우저 알림</option>
            <option value="both" selected>둘 다</option>
            <option value="off">끔</option>
          </select>
        </label>
      </div>
    </div>
    <table id="ordersTbl"><thead>
      <tr><th>시간</th><th>테이블</th><th>항목(이름 × 수량)</th><th>금액</th><th>상태</th><th>조치</th></tr>
    </thead><tbody></tbody></table>
    
  </div>

  <div id="pane-tables" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <b>테이블 현황</b>
      <div class="row">
        <button class="btn" id="addTable">테이블 +1</button>
        <button class="btn" id="resetTables">초기화(3개)</button>
      </div>
    </div>
    <div id="tablesGrid" class="grid"></div>
  </div>

  <div id="pane-qr" class="card hidden">
    <div class="row"><input id="qrTable" placeholder="테이블 번호"/>
      <button class="btn" id="makeQR">QR 생성</button>
      <a id="dlPng" class="btn" href="#" download="qr.png">PNG 다운로드</a>
      <button class="btn" id="saveQR">페이지에 저장</button>
      <button class="btn" id="exportQRs">내보내기</button>
      <input id="importQRFile" type="file" class="hidden" accept="application/json"/>
      <button class="btn" id="importQR">가져오기</button>
    </div>
    <div style="margin-top:10px"><img id="qrImg" style="background:#fff;border-radius:8px"/></div>
    <h4 style="margin-top:16px">저장된 QR</h4>
    <div id="qrList" class="grid"></div>
  </div>

  <div id="pane-menu" class="card hidden">
    <div class="row"><input id="m_id" placeholder="id"/><input id="m_name" placeholder="이름"/><input id="m_price" type="number" placeholder="가격"/><button class="btn" id="m_add">추가</button></div>
    <table id="menuTbl"><thead><tr><th>ID</th><th>이름</th><th>가격</th><th>판매중</th><th>동작</th></tr></thead><tbody></tbody></table>
    <div class="row" style="margin-top:10px"><input type="file" id="xlsxFile"/><button class="btn" id="m_upload">엑셀 업로드</button></div>
  </div>

  <div id="pane-code" class="card hidden">
    <div class="row">
      <div>오늘의 결제 코드 <span id="dcDate" class="muted"></span></div>
      <span id="dcStatus" class="pill"></span>
      <span id="dcRemain" class="muted"></span>
    </div>
    <div class="row" style="margin-top:10px">
      <input id="dcCode" style="width:140px" readonly>
      <button class="btn" id="copyBtn">복사</button>
      <button class="btn" id="regenBtn">새 코드 발급</button>
      <!-- 되돌리기 버튼 제거 -->
    </div>
  </div>

  <div id="pane-stats" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <b>판매 통계</b>
      <div class="row">
        <label>기간
          <select id="statPeriod"><option value="day">일별</option><option value="week">주별</option><option value="month" selected>월별</option><option value="year">연간</option></select>
        </label>
      </div>
    </div>
    <div class="row"><span class="pill" id="statSummary"></span></div>
    <h4>메뉴별 판매</h4>
    <table id="statItems"><thead><tr><th>메뉴</th><th>수량</th><th>매출</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<script>
let API='', ORDER_BASE='', TOKEN=localStorage.getItem('adminToken')||'';
function authHeaders(){ return { 'Content-Type':'application/json', 'Authorization':'Bearer '+TOKEN }; }
function api(p){ return API + p; }
function setTabActive(name){
  document.querySelectorAll('.tab').forEach(t=> t.classList.remove('active'));
  document.querySelector('.tab[data-tab="'+name+'"]').classList.add('active');
  document.querySelectorAll('[id^=pane-]').forEach(p=> p.classList.add('hidden'));
  document.getElementById('pane-'+name).classList.remove('hidden');
}
document.querySelectorAll('.tab').forEach(t=> t.onclick=()=> setTabActive(t.dataset.tab));

// login/logout toggle
function updateAuthButtons(){
  const has=!!TOKEN;
  document.getElementById('loginBtn').classList.toggle('hidden', has);
  document.getElementById('logoutBtn').classList.toggle('hidden', !has);
}
document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('adminToken'); TOKEN=''; updateAuthButtons(); location.href='/login'; };

// --- DATA ---
let MENU=[], MENU_MAP={};
const ordersTbody=document.querySelector('#ordersTbl tbody');
const filterStatus=document.getElementById('filterStatus');
filterStatus.onchange=loadOrders;

// map items to "이름 × 수량"
function formatItems(items){
  return (items||[]).map(([id,q])=>{
    const name = MENU_MAP[id]||id;
    return name+' × '+q;
  }).join(', ');
}

function rowHtml(o){
  const items = formatItems(o.items);
  const sel = '<select class="st"><option '+(o.status==='접수'?'selected':'')+'>접수</option><option '+(o.status==='준비중'?'selected':'')+'>준비중</option><option '+(o.status==='완료'?'selected':'')+'>완료</option><option '+(o.status==='취소'?'selected':'')+'>취소</option><option '+(o.status==='환불'?'selected':'')+'>환불</option></select>';
  const btns = '<button class="btn act-save">저장</button> <button class="btn act-refund">환불</button>';
  return '<tr data-id="'+o.id+'"><td>'+new Date(o.createdAt||Date.now()).toLocaleString()+'</td><td>'+(o.tableNo||'')+'</td><td>'+items+'</td><td>'+Number(o.amount||0).toLocaleString('ko-KR')+'</td><td>'+(o.status||'')+'</td><td>'+sel+' '+btns+'</td></tr>';
}

async function loadOrders(){
  const r=await fetch(api('/orders')); if(!r.ok) return;
  const arr=await r.json();
  const fil=filterStatus.value?arr.filter(o=>o.status===filterStatus.value):arr;
  ordersTbody.innerHTML=fil.map(rowHtml).join('');
}

ordersTbody.addEventListener('click', async (e)=>{
  const tr=e.target.closest('tr'); if(!tr||!TOKEN) return;
  const id=tr.getAttribute('data-id');
  if(e.target.classList.contains('act-save')){
    const st=tr.querySelector('select.st').value;
    const r=await fetch(api('/orders/'+encodeURIComponent(id)+'/status'), { method:'PATCH', headers:authHeaders(), body: JSON.stringify({ status: st }) });
    if(r.ok){ await loadOrders(); }
  }
  if(e.target.classList.contains('act-refund')){
    if(!confirm('환불 처리(표시)할까요? 실제 결제 취소는 포함되지 않습니다.')) return;
    const r=await fetch(api('/orders/'+encodeURIComponent(id)+'/refund'), { method:'POST', headers:authHeaders() });
    if(r.ok){ await loadOrders(); }
  }
});

// SSE: new orders notify
(function sse(){
  try{
    const es = new EventSource('/events/orders'); // admin origin proxy
    es.onmessage = (ev)=>{
      if(!ev.data) return;
      try{ const d=JSON.parse(ev.data); if(d && d.type==='order'){ onNewOrder(d.order); } }catch(_){}
    };
  }catch(e){ /* silent */ }
})();



function onNewOrder(o){
  loadOrders();
  const mode=document.getElementById('notifyMode').value;
  function beep(){
    try{
      const C=window.AudioContext||window.webkitAudioContext; if(!C) return;
      const ac=new C();
      const osc=ac.createOscillator();
      const gn=ac.createGain();
      osc.connect(gn); gn.connect(ac.destination);
      osc.type='sine'; osc.frequency.value=880; gn.gain.value=0.0001;
      osc.start();
      gn.gain.exponentialRampToValueAtTime(0.2, ac.currentTime+0.01);
      gn.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.3);
      osc.stop(ac.currentTime+0.3);
    }catch(e){}
  }
  if(mode==='sound'||mode==='both'){ beep(); }
  if((mode==='browser'||mode==='both') && 'Notification' in window){
    if(Notification.permission==='granted'){
      new Notification('새 주문', { body: '테이블 '+(o.tableNo||'')+' · '+formatItems(o.items), tag:'order' });
    }else if(Notification.permission!=='denied'){
      Notification.requestPermission().then(p=>{ if(p==='granted'){ new Notification('새 주문 알림이 활성화되었습니다'); } });
    }
  }
}

  if(mode==='sound'||mode==='both'){ beep(); }
  if((mode==='browser'||mode==='both') && 'Notification' in window){
    if(Notification.permission==='granted'){
      new Notification('새 주문', { body: '테이블 '+(o.tableNo||'')+' · '+formatItems(o.items), tag:'order' });
    }else if(Notification.permission!=='denied'){
      Notification.requestPermission().then(p=>{ if(p==='granted'){ new Notification('새 주문 알림이 활성화되었습니다'); } });
    }
  }
}

  if((mode==='browser'||mode==='both') && 'Notification' in window){
    if(Notification.permission==='granted'){
      new Notification('새 주문', { body: '테이블 '+(o.tableNo||'')+' · '+formatItems(o.items), tag:'order' });
    }else if(Notification.permission!=='denied'){
      Notification.requestPermission().then(p=>{ if(p==='granted'){ new Notification('새 주문이 알림으로 표시됩니다'); } });
    }
  }
}

// Export
document.getElementById('exportOrders').onclick=()=>{ if(!TOKEN){ location.href='/login'; return;} window.location.href=api('/export/orders.xlsx')+'?token='+TOKEN; };

// --- QR ---
function qrStorage(){ try{ return JSON.parse(localStorage.getItem('qrSaved')||'[]'); }catch(e){ return []; } }
function saveQrStorage(arr){ localStorage.setItem('qrSaved', JSON.stringify(arr)); renderSavedQrs(); }
document.getElementById('makeQR').onclick=()=>{
  if(!TOKEN){ location.href='/login'; return; }
  const t=document.getElementById('qrTable').value||'';
  const link=ORDER_BASE + '/?table=' + encodeURIComponent(t);
  const apiQR=api('/qr?size=220x220&data='+encodeURIComponent(link));
  document.getElementById('qrImg').src=apiQR; document.getElementById('dlPng').href=apiQR;
};
document.getElementById('saveQR').onclick=()=>{
  const t=document.getElementById('qrTable').value||''; if(!t) return;
  const link=ORDER_BASE + '/?table=' + encodeURIComponent(t);
  const list=qrStorage(); if(!list.find(x=>x.table===t)) list.push({ table:t, url: link });
  saveQrStorage(list);
};
function renderSavedQrs(){
  const list=qrStorage();
  const cont=document.getElementById('qrList'); cont.innerHTML='';
  list.forEach(x=>{
    const apiQR=api('/qr?size=160x160&data='+encodeURIComponent(x.url));
    const el=document.createElement('div'); el.className='tile';
    el.innerHTML='<div><b>테이블 '+x.table+'</b></div><img src="'+apiQR+'" style="background:#fff;border-radius:8px"/><div class="row"><a class="btn" href="'+apiQR+'" download="qr_'+x.table+'.png">다운로드</a><button class="btn rm">삭제</button></div>';
    el.querySelector('.rm').onclick=()=>{ const arr=qrStorage().filter(i=>i.table!==x.table); saveQrStorage(arr); };
    cont.appendChild(el);
  });
}
document.getElementById('exportQRs').onclick=()=>{
  const data = JSON.stringify(qrStorage(), null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='qrs.json'; a.click(); URL.revokeObjectURL(url);
};
document.getElementById('importQR').onclick=()=> document.getElementById('importQRFile').click();
document.getElementById('importQRFile').onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=()=>{ try{ const arr=JSON.parse(rd.result||'[]'); saveQrStorage(Array.isArray(arr)?arr:[]);}catch(_){alert('잘못된 파일');} };
  rd.readAsText(f);
};

// --- MENU (sold out via active=false) ---
const menuTbody=document.querySelector('#menuTbl tbody');
async function loadMenu(){ const r=await fetch(api('/menu')); if(!r.ok) return; const arr=await r.json(); MENU=arr; MENU_MAP={}; arr.forEach(m=> MENU_MAP[m.id]=m.name); menuTbody.innerHTML=arr.map(trHtml).join(''); }
function trHtml(m){
  return '<tr data-id="'+m.id+'"><td>'+m.id+'</td><td><input value="'+(m.name||'')+'" class="m_name"></td><td><input type="number" value="'+(m.price||0)+'" class="m_price" style="width:100px"></td><td><input type="checkbox" class="m_active" '+(m.active?'checked':'')+'></td><td><button class="btn m_save">저장</button> <button class="btn m_del">삭제</button></td></tr>';
}
menuTbody.addEventListener('click', async (e)=>{
  const tr=e.target.closest('tr'); if(!tr) return; const id=tr.getAttribute('data-id');
  if(e.target.classList.contains('m_save')){
    if(!TOKEN){ location.href='/login'; return; }
    const name=tr.querySelector('.m_name').value.trim();
    const price=Number(tr.querySelector('.m_price').value||0);
    const active=tr.querySelector('.m_active').checked;
    const r=await fetch(api('/menu/'+encodeURIComponent(id)),{method:'PATCH',headers:authHeaders(),body:JSON.stringify({name,price,active})});
    if(r.ok){ await loadMenu(); }
  }
  if(e.target.classList.contains('m_del')){
    if(!TOKEN){ location.href='/login'; return; }
    if(!confirm('삭제할까요?')) return;
    const r=await fetch(api('/menu/'+encodeURIComponent(id)),{method:'DELETE',headers:authHeaders()});
    if(r.ok){ await loadMenu(); }
  }
});
document.getElementById('m_add').onclick=async()=>{
  if(!TOKEN){ location.href='/login'; return; }
  const id=m_id.value.trim(), name=m_name.value.trim(), price=Number(m_price.value||0);
  if(!id||!name||!price){ alert('id, 이름, 가격 입력'); return; }
  const r=await fetch(api('/menu'), {method:'POST', headers:authHeaders(), body: JSON.stringify({id,name,price,active:true})});
  if(r.ok){ m_id.value=m_name.value=m_price.value=''; await loadMenu(); }
};

// Excel upload (same)
document.getElementById('m_upload').onclick=async()=>{
  if(!TOKEN){ location.href='/login'; return; }
  const f=document.getElementById('xlsxFile').files[0]; if(!f){ alert('파일 선택'); return; }
  const fd=new FormData(); fd.append('file', f);
  const r=await fetch(api('/import/menu'), { method:'POST', headers:{ 'Authorization':'Bearer '+TOKEN }, body: fd });
  if(r.ok){ await loadMenu(); }
};

// --- Daily Code ---
function untilMidnightText(){ const now=new Date(); const end=new Date(); end.setHours(24,0,0,0); const ms=end-now; const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000); return '자정까지 '+h+'시간 '+m+'분'; }
function updateRemain(){ const el=document.getElementById('dcRemain'); if(el) el.textContent=untilMidnightText(); }
setInterval(updateRemain, 60000);
async function loadDailyCode(){
  if(!TOKEN) return;
  const r=await fetch(api('/daily-code'), { headers: authHeaders() }); if(!r.ok) return;
  const j=await r.json(); dcDate.textContent='('+j.date+')'; dcCode.value=j.code; dcStatus.textContent=j.override?'오버라이드(오늘만)':'기본 코드'; dcStatus.className='pill '+(j.override?'warn':'ok'); updateRemain();
}
document.getElementById('regenBtn').onclick=async()=>{ if(!TOKEN){ location.href='/login'; return; } const r=await fetch(api('/daily-code/regen'), { method:'POST', headers:authHeaders() }); if(r.ok){ await loadDailyCode(); } };
document.getElementById('copyBtn').onclick=()=> navigator.clipboard?.writeText(dcCode.value);

// --- TABLES ---
function getTableCount(){ return Number(localStorage.getItem('tblCount')||'3'); }
function setTableCount(n){ localStorage.setItem('tblCount', String(n)); renderTables(); }
document.getElementById('addTable').onclick=()=> setTableCount(getTableCount()+1);
document.getElementById('resetTables').onclick=()=> setTableCount(3);
async function renderTables(){
  const grid=document.getElementById('tablesGrid'); grid.innerHTML='';
  const r=await fetch(api('/orders')); const arr=r.ok?await r.json():[];
  const cnt=getTableCount();
  for(let i=1;i<=cnt;i++){
    const cur=arr.filter(o=>String(o.tableNo)===String(i) && (o.status==='접수'||o.status==='준비중'));
    const items=cur.flatMap(o=>o.items||[]).reduce((acc,[id,q])=>{ const name=MENU_MAP[id]||id; acc[name]=(acc[name]||0)+q; return acc; },{});
    const list=Object.entries(items).map(([n,q])=> n+' × '+q).join(', ') || '<span class="muted">주문 없음</span>';
    const el=document.createElement('div'); el.className='tile';
    el.innerHTML='<div class="row" style="justify-content:space-between"><b>테이블 '+i+'</b><button class="btn clear">비우기</button></div><div style="margin-top:6px">'+list+'</div>';
    el.querySelector('.clear').onclick=async()=>{
      if(!TOKEN){ location.href='/login'; return; }
      for(const o of cur){
        await fetch(api('/orders/'+encodeURIComponent(o.id)+'/status'), { method:'PATCH', headers:authHeaders(), body: JSON.stringify({ status: '완료' }) });
      }
      renderTables(); loadOrders();
    };
    grid.appendChild(el);
  }
}

// --- STATS ---
const statBody=document.querySelector('#statItems tbody');
const statSummary=document.getElementById('statSummary');
document.getElementById('statPeriod').onchange=renderStats;

async function renderStats(){
  const r=await fetch(api('/orders')); if(!r.ok) return; const arr=await r.json();
  const period=document.getElementById('statPeriod').value;
  const byItem={}; let total=0;
  const now=new Date();
  const start = (function(){ const d=new Date(); if(period==='day'){ d.setHours(0,0,0,0);} else if(period==='week'){ const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0);} else if(period==='month'){ d.setDate(1); d.setHours(0,0,0,0);} else { d.setMonth(0,1); d.setHours(0,0,0,0);} return d; })();
  for(const o of arr){
    const t=new Date(o.createdAt||Date.now());
    if(t<start) continue;
    if(o.status==='취소') continue; // exclude canceled
    total += Number(o.amount||0);
    for(const [id,q] of (o.items||[])){
      const name=MENU_MAP[id]||id;
      byItem[name] = byItem[name]||{ qty:0, sales:0 };
      byItem[name].qty += q;
      byItem[name].sales += (MENU.find(m=>m.id===id)?.price||0)*q;
    }
  }
  const rows = Object.entries(byItem).sort((a,b)=>b[1].sales-a[1].sales).map(([name,v])=>'<tr><td>'+name+'</td><td>'+v.qty+'</td><td>'+v.sales.toLocaleString('ko-KR')+'</td></tr>').join('');
  statBody.innerHTML=rows||'<tr><td colspan=3 class="muted">데이터 없음</td></tr>';
  statSummary.textContent='총 매출: '+total.toLocaleString('ko-KR');
}

// init
async function init(){
  const r=await fetch('/admin-config'); const j=await r.json(); API=j.apiBase; ORDER_BASE=j.orderBase;
  updateAuthButtons();
  if(!TOKEN) return;
  try{ await Promise.all([loadMenu(), loadOrders(), loadDailyCode(), renderTables(), renderStats()]); }catch(e){}
}
init();
</script>
</body></html>