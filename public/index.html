<!doctype html><html lang="ko"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>관리자 콘솔</title>
<style>
  :root{--bg:#0b0f14;--panel:#0d131b;--line:#223;--text:#e6edf3;--muted:#9fb0c3}
  body{font-family:system-ui,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text);margin:0}
  .wrap{max-width:980px;margin:22px auto;padding:16px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:10px 14px;border:1px solid #294760;border-radius:10px;background:#0c1a28;cursor:pointer}
  .tab.active{outline:2px solid #2a6ea9}
  .card{background:#0d131b;border:1px solid #223;border-radius:14px;padding:14px;margin-bottom:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 12px;border:1px solid #294760;border-radius:10px;background:linear-gradient(180deg,#0d2233,#0a1824);color:#e6edf3;cursor:pointer}
  input,select{padding:8px;border-radius:10px;border:1px solid #223;background:#0e1520;color:#e6edf3}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #222;padding:8px;text-align:left}
  .pill{display:inline-block;padding:4px 8px;border-radius:24px;border:1px solid #345;font-size:12px}
  .pill.ok{background:#0b2a18;border-color:#1f4e32;color:#b3ffcf}
  .pill.warn{background:#2a160b;border-color:#4e331f;color:#ffd9b3}
  .muted{color:var(--muted)} .hidden{display:none}

/* QR helper (v5.13k) */
.qr-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:8px}
.qr-card{background:#0e1a26;border:1px solid #234;border-radius:12px;padding:10px;text-align:center}
.qr-card img{width:100%;height:auto;image-rendering:pixelated}
.qr-meta{margin-top:6px;font-weight:600}
.qr-actions{display:flex;gap:8px;justify-content:center;margin-top:6px}


/* Helpers v5.13m2 */
.qr-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:8px}
.qr-card{background:#0e1a26;border:1px solid #234;border-radius:12px;padding:10px;text-align:center}
.qr-card img{width:100%;height:auto;image-rendering:pixelated}
.qr-meta{margin-top:6px;font-weight:600}
.qr-actions{display:flex;gap:8px;justify-content:center;margin-top:6px}
.pill.ok{background:#0b2a18;border-color:#1f4e32;color:#b3ffcf}
.pill.bad{background:#2a160b;border-color:#4e331f;color:#ffd9b3}

</style>
</head><body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h2>관리자 콘솔</h2>
    <div class="row">
      <a class="btn" href="/login">로그인</a>
      <button class="btn" id="logoutBtn">로그아웃</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="orders">주문목록</div>
    <div class="tab" data-tab="qr">QR 배포</div>
    <div class="tab" data-tab="menu">메뉴 관리</div>
    <div class="tab" data-tab="code">결제 코드</div>
    <div class="tab" data-tab="notify">알림 설정</div>
  </div>

  <div id="pane-orders" class="card">
    <div class="row" style="justify-content:space-between">
      <div><b>주문목록</b></div>
      <button class="btn" id="exportOrders">엑셀 다운로드</button>
    </div>
    <table id="ordersTbl"><thead><tr><th>시간</th><th>테이블</th><th>항목</th><th>금액</th><th>상태</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="pane-qr" class="card hidden">
    <div class="row"><input id="qrTable" placeholder="테이블 번호"/> <button class="btn" id="makeQR">QR 생성</button> <a id="dlPng" class="btn" href="#" download="qr.png">PNG 다운로드</a></div>
    <div style="margin-top:10px"><img id="qrImg" style="background:#fff;border-radius:8px"/></div>
  </div>

  <div id="pane-menu" class="card hidden">
    <div class="row"><input id="m_id" placeholder="id"/><input id="m_name" placeholder="이름"/><input id="m_price" placeholder="가격" type="number"/><button class="btn" id="m_add">추가</button></div>
    <table id="menuTbl"><thead><tr><th>ID</th><th>이름</th><th>가격</th><th>활성</th><th>동작</th></tr></thead><tbody></tbody></table>
    <div class="row" style="margin-top:10px"><input type="file" id="xlsxFile"/><button class="btn" id="m_upload">엑셀 업로드</button></div>
  </div>

  <div id="pane-code" class="card hidden">
    <div class="row">
      <div>오늘의 결제 코드 <span id="dcDate" class="muted"></span></div>
      <span id="dcStatus" class="pill"></span>
      <span id="dcRemain" class="muted"></span>
    </div>
    <div class="row" style="margin-top:10px">
      <input id="dcCode" style="width:140px" readonly>
      <button class="btn" id="copyBtn">복사</button>
      <button class="btn" id="regenBtn">새 코드 발급</button>
      <button class="btn" id="clearBtn">기본 코드로 되돌리기</button>
    </div>
  </div>
</div>




<script>(function(){if(window.__QR_CTRL_513L)return;window.__QR_CTRL_513L=true;
var HAS_TOKEN=!!(window.localStorage&&localStorage.getItem('adminToken'));
function $(s,r){return(r||document).querySelector(s);}function $all(s,r){return Array.prototype.slice.call((r||document).querySelectorAll(s));}
function textOf(e){return(e&&(e.textContent||e.innerText||e.value||'')).trim();}function visible(e){return e&&e.offsetParent!==null&&!e.disabled;}
function now(){return (new Date()).getTime();}function ymd(ts){var d=ts?new Date(ts):new Date();var y=d.getFullYear();var m=('0'+(d.getMonth()+1)).slice(-2);var a=('0'+d.getDate()).slice(-2);return y+'-'+m+'-'+a;}
function findCard(){var c=document.getElementById('pane-qr');if(c)return c;var inputs=$all('input');for(var i=0;i<inputs.length;i++){if((inputs[i].placeholder||'').indexOf('테이블 번호')>=0){return inputs[i].closest('.card')||document.body;}}return document.body;}
function findBtnByText(card,txt){var els=$all('button,a',card);for(var i=0;i<els.length;i++){if(textOf(els[i]).indexOf(txt)>=0)return els[i];}return null;}
function ensureUI(card){var gen=findBtnByText(card,'QR 생성');var dl=findBtnByText(card,'PNG 다운로드');var save=findBtnByText(card,'QR 저장');if(!save){if(gen&&gen.parentNode){save=document.createElement('button');save.className=gen.className||'btn';save.id='btnQrSaveTop';save.textContent='QR 저장';gen.parentNode.insertBefore(save,gen.nextSibling);}}if(!HAS_TOKEN&&save){save.style.display='none';}var title=$('h4[data-det-saved]',card);if(!title){title=document.createElement('h4');title.setAttribute('data-det-saved','1');title.textContent='저장된 QR';card.appendChild(title);}var grid=document.getElementById('qrSavedList');if(!grid){grid=document.createElement('div');grid.id='qrSavedList';grid.className='qr-grid';card.appendChild(grid);}if(!HAS_TOKEN){title.style.display='none';grid.style.display='none';}else{title.style.display='';grid.style.display='';}return {gen:gen,dl:dl,save:save,title:title,grid:grid};}
function getList(){if(!HAS_TOKEN)return[];try{return JSON.parse(localStorage.getItem('__qr_saved_list')||'[]');}catch(e){return[];}}function setList(l){if(!HAS_TOKEN)return;localStorage.setItem('__qr_saved_list',JSON.stringify(l));}
function render(grid){if(!HAS_TOKEN){grid.innerHTML='';return;}var list=getList();if(!list.length){grid.innerHTML='<div style="opacity:.7">저장된 QR이 없습니다. QR 생성 후 [QR 저장]을 눌러 추가하세요.</div>';return;}grid.innerHTML='';list.forEach(function(it,i){var cd=document.createElement('div');cd.className='qr-card';var img=document.createElement('img');img.src=it.url||it.dataUrl||'';img.alt='QR '+(it.table||'');var meta=document.createElement('div');meta.className='qr-meta';meta.textContent='테이블 '+(it.table||'');var acts=document.createElement('div');acts.className='qr-actions';var bdl=document.createElement('button');bdl.className='btn';bdl.textContent='다운로드';(function(u,t,ts,idx){bdl.onclick=function(){fetch(u).then(r=>r.blob()).then(b=>{var o=URL.createObjectURL(b);var name='qr'+(t?('_'+t):'')+'_'+ymd(ts||now())+'.png';var a=document.createElement('a');a.href=o;a.download=name;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(o),4000);}).catch(()=>{var a2=document.createElement('a');a2.href=u;a2.target='_blank';a2.rel='noopener';a2.click();});};})(img.src,it.table,it.ts,i);var brm=document.createElement('button');brm.className='btn';brm.textContent='삭제';brm.onclick=(function(idx){return function(){var l=getList().filter(function(_,j){return j!==idx;});setList(l);render(grid);};})(i);acts.appendChild(bdl);acts.appendChild(brm);cd.appendChild(img);cd.appendChild(meta);cd.appendChild(acts);grid.appendChild(cd);});}
function tableValue(card){var inp=$('input[type=\"text\"]',card)||$('input',card);return (inp&&inp.value||'').trim();}
function currentImgUrl(card){var img=$('#qrImg',card);if(img&&img.src)return img.src;var dl=findBtnByText(card,'PNG 다운로드');if(dl&&dl.href)return dl.href;return '';}
function wireDownload(card,ui){function handle(ev){if(ev){ev.preventDefault();ev.stopPropagation();}var src=currentImgUrl(card);if(!src)return;var t=(function(){var inp=document.querySelector('#pane-qr input')||document.querySelector('input');return (inp&&inp.value)||'';})();fetch(src).then(r=>r.blob()).then(b=>{var o=URL.createObjectURL(b);var name='qr'+(t?('_'+t.trim()):'')+'_'+ymd(now())+'.png';var a=document.createElement('a');a.href=o;a.download=name;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(o),4000);}).catch(()=>{var a2=document.createElement('a');a2.href=src;a2.target='_blank';a2.rel='noopener';a2.click();});}if(ui.dl){ui.dl.addEventListener('click',handle,true);}var img=$('#qrImg',card);if(img){img.style.cursor='pointer';img.title='클릭하면 PNG로 다운로드';img.addEventListener('click',handle,true);}}
function hookSave(card,ui){if(!ui.save)return;ui.save.onclick=function(){if(!HAS_TOKEN){alert('로그인 후 이용해 주세요.');return;}var t=tableValue(card)||prompt('테이블 번호를 입력하세요')||'';if(!t)return;var src=currentImgUrl(card);if(!src)return;var l=getList();var idx=l.findIndex(function(it){return String(it.table||'')===String(t);});var item={table:String(t),url:src,ts:now()};if(idx>=0)l[idx]=item;else l.push(item);setList(l);render(ui.grid);};}
document.addEventListener('DOMContentLoaded',function(){var card=findCard();var ui=ensureUI(card);render(ui.grid);wireDownload(card,ui);var gen=ui.gen;if(gen){gen.addEventListener('click',function(){setTimeout(function(){},80);});}hookSave(card,ui);});})();</script>


<script>(function(){if(window.__NT_CTRL_220)return;window.__NT_CTRL_220=true;
const NT={ctx:null,enabled:false,lastKeys:[],maxKeys:20};
const SKEY='__qr_user_beep_enabled_v2';
function log(s){try{const el=document.getElementById('ntLog'); if(el){el.textContent = (el.textContent?el.textContent+'\n':'') + s;}}catch(_){}} 
function setConn(state){const el=document.getElementById('ntConn'); if(!el)return; if(state==='ok'){el.textContent='연결됨'; el.className='pill ok';} else if(state==='down'){el.textContent='끊김'; el.className='pill bad';} else {el.textContent='확인 중…'; el.className='pill';}}
function setPerm(){const p=(window.Notification&&Notification.permission)||'unsupported'; const el=document.getElementById('ntPerm'); if(!el)return; el.textContent=p; el.className='pill '+(p==='granted'?'ok':(p==='denied'?'bad':''));}
function ensureCtx(){ if(NT.ctx) return NT.ctx; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; NT.ctx=new AC(); return NT.ctx;}
function enableBeep(){NT.enabled=true; localStorage.setItem(SKEY,'1'); try{const c=ensureCtx(); if(c&&c.state==='suspended'){c.resume();}}catch(_){}} 
function beep(){ try{ if(!NT.enabled) return; const c=ensureCtx(); if(!c) return; const o=c.createOscillator(); const g=c.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.1; o.connect(g); g.connect(c.destination); o.start(); setTimeout(()=>{o.stop(); o.disconnect(); g.disconnect();}, 180); }catch(_){ } }
function notifyBrowser(title, body){ try{ if(!('Notification' in window)) return; if(Notification.permission==='granted'){ new Notification(title, { body: body }); } }catch(_){ } }
function dedup(key){ NT.lastKeys.push({key,ts:Date.now()}); if(NT.lastKeys.length>NT.maxKeys) NT.lastKeys.shift(); const recent=NT.lastKeys.filter(x=>Date.now()-x.ts<5000).map(x=>x.key); return recent.filter(k=>k===key).length<=1; }

function attachButtons(){
  const btnE=document.getElementById('ntEnableSound'); if(btnE){ btnE.onclick=function(){ enableBeep(); beep(); log('소리 활성화됨'); }; }
  const btnT=document.getElementById('ntTestSound'); if(btnT){ btnT.onclick=function(){ enableBeep(); beep(); log('소리 테스트'); }; }
  const btnP=document.getElementById('ntAskPerm'); if(btnP){ btnP.onclick=function(){ try{ Notification.requestPermission().then(setPerm); }catch(_){ setPerm(); } }; }
  const btnB=document.getElementById('ntTestBrowser'); if(btnB){ btnB.onclick=function(){ notifyBrowser('테스트 알림','브라우저 알림이 동작 중입니다.'); beep(); }; }
}

function parsePayload(data){ try{ return JSON.parse(data); }catch(_){ return { message: data }; } }
function handleCall(payload){
  const table = payload.table || payload.tableNo || payload.t || '';
  const key = 'call:'+String(table||'')+':'+(payload.at||payload.id||payload.ts||'');
  if(!dedup(key)) return;
  beep(); notifyBrowser('직원 호출', (table?('테이블 '+table+'에서 호출'): '직원 호출') );
  try{ log('[직원 호출] '+ (table?('테이블 '+table):'')); }catch(_){ }
}

function wireSSE(){
  if(!window.EventSource) { setConn('down'); return; }
  setConn('checking');
  const endpoints = ['/events/admin','/events/notify','/events/alerts','/events/orders'];
  let connected=false;
  endpoints.forEach((ep, idx)=>{
    try{
      const es = new EventSource((window.API||'')+ep);
      es.addEventListener('open', ()=>{ if(!connected){ connected=true; setConn('ok'); } });
      es.addEventListener('error', ()=>{ if(!connected && idx===endpoints.length-1) setConn('down'); });
      ['staff','staff_call','assist','call','notify','message'].forEach(ev=>{
        es.addEventListener(ev, e=>{ const p=parsePayload(e.data||''); if(p && (String(p.type||'').toLowerCase().indexOf('staff')>=0 || ev==='staff' || ev==='staff_call' || ev==='assist' || ev==='call')) handleCall(p); });
      });
      es.onmessage = (e)=>{ const p=parsePayload(e.data||''); if(p && (p.type==='staff_call'||p.kind==='staff_call'||p.event==='staff_call')) handleCall(p); };
    }catch(_){}
  });
}

document.addEventListener('DOMContentLoaded', function(){
  try{ NT.enabled = localStorage.getItem(SKEY)==='1'; }catch(_){}
  setPerm(); attachButtons(); wireSSE();
});
})();</script>

</body></html>
